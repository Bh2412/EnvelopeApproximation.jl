using EnvelopeApproximation
using EnvelopeApproximation.BubbleBasics
import EnvelopeApproximation.BubbleBasics: Vec3
using EnvelopeApproximation.BubblesEvolution
using EnvelopeApproximation.GeometricStressEnergyTensor
import EnvelopeApproximation.ChebyshevCFT: First3MomentsChebyshevPlan
import EnvelopeApproximation.GeometricStressEnergyTensor: Δ, k̂ik̂j∂_iφ∂_jφ, k̂ik̂jTij
import LinearAlgebra: norm
using BenchmarkTools
using HCubature
using StaticArrays
import EnvelopeApproximation.ISWPowerSpectrum: align_ẑ
import EnvelopeApproximation.ISWPowerSpectrum.VolumeVolume: P, potential_integral, BallSpace, V
import EnvelopeApproximation.ISWPowerSpectrum: surface_P, P as total_P
using CSV

begin
    R = 4.79
    d = 1.2
    nucleations = [(time=0., site=Point3(0., 0., -d / 2)), (time=0., site=Point3(0., 0., d / 2))]
    snapshot = BubblesSnapShot(nucleations, R)
    bubbles = current_bubbles(snapshot)
    space = BallSpace(d + 2.1R, Point3(0., 0., 0.))
    k_0 = 2π / (R + d / 2)
    ks = logrange(k_0 / 100, k_0 * 10, 2000)
    ΔV = 1.
    chebyshev_plan = First3MomentsChebyshevPlan{32}()
    _Δ = Δ(4)
end

using CairoMakie

begin
    bubbles = current_bubbles(snapshot)
    figure = Figure()
    ax = Axis(figure[1, 1], xlabel=L"k[β]", ylabel=L"$|V(k)|$",
              xscale=log10,
              title="2 Bubble Volume-Volume, R=$R, d=$d")
    lines!(ax, ks, potential_integral(ks, bubbles, space, chebyshev_plan, _Δ; ΔV=ΔV) .|> abs ,label=L"T_{zz}")
    # lines!(ax, ks, k̂ik̂j∂_iφ∂_jφ(ks, current_bubbles(align_ẑ(Vec3(1., 0., 0.)) * snapshot), chebyshev_plan, _Δ; ΔV=ΔV) .|> abs, label=L"T_{xx}")
    # lines!(ax, ks, k̂ik̂j∂_iφ∂_jφ(ks, current_bubbles(align_ẑ(Vec3(0., 1., 0.)) * snapshot), chebyshev_plan, _Δ; ΔV=ΔV) .|> abs, label=L"T_{yy}", linestyle=:dash)
    # lines!(ax, ks, k̂ik̂j∂_iφ∂_jφ(ks, bubbles, chebyshev_plan, _Δ; ΔV=ΔV) .|> abs, label=L"$(\frac{\partial \varphi}{\partial z})^2$")
    # axislegend(ax)
    save("/home/ben/Pictures/2_bubble_V.png", figure)
    figure
end

begin
    # @profview for _ in 1:10 surface_P(ks, snapshot, chebyshev_plan, _Δ; rtol=1e-3) end
    @time vp = P(ks, snapshot, space, chebyshev_plan, _Δ; rtol=1e-3) * V(space)
    @time sp = surface_P(ks, snapshot, space, chebyshev_plan, _Δ; rtol=1e-3) * V(space)
    @time tp = total_P(ks, snapshot, space, chebyshev_plan, _Δ; rtol=1e-3) * V(space)
    # x̂ = Vec3(1., 0., 0.)
    # ŷ = Vec3(0., 1., 0.)
    # @time xsp = surface_P(ks, align_ẑ(x̂) * snapshot, chebyshev_plan, _Δ; rtol=1e-3)
    # @time ysp = surface_P(ks, align_ẑ(ŷ) * snapshot, chebyshev_plan, _Δ; rtol=1e-3)
end

# begin
#     μ = rand() * 2 - 1
#     ϕ = rand() * 2π
#     random_n̂ = Vec3(sqrt(1 - μ ^ 2) * cos(ϕ), sqrt(1 - μ ^ 2) * sin(ϕ), μ)
#     @show random_n̂
#     @time n̂sp = surface_P(ks, align_ẑ(random_n̂) * snapshot, chebyshev_plan, _Δ; rtol=1e-3)
# end

# begin
#     salvatore_ks = [0.1, 0.101, 0.10201, 0.1030301, 0.10406040100000001, 0.10510100501000003, 0.10615201506010002, 0.10721353521070101, 0.10828567056280802, 0.1093685272684361, 0.11046221254112046, 0.11156683466653167, 0.11268250301319699, 0.11380932804332895, 0.11494742132376226, 0.11609689553699987, 0.11725786449236988, 0.11843044313729356, 0.11961474756866651, 0.12081089504435316, 0.1220190039947967, 0.12323919403474469, 0.12447158597509211, 0.12571630183484303, 0.12697346485319147, 0.1282431995017234, 0.12952563149674065, 0.13082088781170806, 0.13212909668982512, 0.13345038765672337, 0.13478489153329062, 0.13613274044862353, 0.13749406785310975, 0.13886900853164083, 0.14025769861695725, 0.14166027560312683, 0.1430768783591581, 0.1445076471427497, 0.1459527236141772, 0.14741225085031895, 0.14888637335882213, 0.15037523709241038, 0.15187898946333447, 0.15339777935796783, 0.1549317571515475, 0.15648107472306297, 0.1580458854702936, 0.15962634432499656, 0.1612226077682465, 0.16283483384592898, 0.16446318218438827, 0.16610781400623217, 0.16776889214629448, 0.16944658106775742, 0.171141046878435, 0.17285245734721935, 0.17458098192069155, 0.17632679173989846, 0.17809005965729746, 0.17987096025387042, 0.18166966985640914, 0.18348636655497322, 0.18532123022052296, 0.1871744425227282, 0.1890461869479555, 0.19093664881743502, 0.19284601530560938, 0.19477447545866547, 0.19672222021325214, 0.19868944241538466, 0.20067633683953853, 0.2026831002079339, 0.20470993121001324, 0.20675703052211336, 0.2088246008273345, 0.21091284683560785, 0.21302197530396394, 0.2151521950570036, 0.21730371700757362, 0.21947675417764934, 0.22167152171942583, 0.2238882369366201, 0.2261271193059863, 0.22838839049904616, 0.23067227440403665, 0.23297899714807702, 0.2353087871195578, 0.23766187499075336, 0.24003849374066089, 0.2424388786780675, 0.24486326746484816, 0.24731190013949667, 0.24978501914089166, 0.25228286933230054, 0.2548056980256236, 0.2573537550058798, 0.25992729255593855, 0.262526565481498, 0.26515183113631297, 0.2678033494476761, 0.27048138294215285, 0.2731861967715744, 0.27591805873929015, 0.27867723932668303, 0.2814640117199499, 0.28427865183714934, 0.2871214383555209, 0.2899926527390761, 0.29289257926646683, 0.2958215050591315, 0.2987797201097228, 0.3017675173108201, 0.30478519248392827, 0.3078330444087676, 0.31091137485285525, 0.31402048860138376, 0.3171606934873976, 0.3203323004222716, 0.32353562342649433, 0.3267709796607593, 0.33003868945736686, 0.33333907635194054, 0.33667246711545995, 0.34003919178661457, 0.3434395837044807, 0.3468739795415255, 0.3503427193369408, 0.3538461465303102, 0.3573846079956133, 0.3609584540755694, 0.36456803861632514, 0.36821371900248834, 0.37189585619251325, 0.3756148147544384, 0.3793709629019828, 0.3831646725310026, 0.3869963192563126, 0.3908662824488758, 0.39477494527336454, 0.3987226947260982, 0.4027099216733592, 0.4067370208900927, 0.41080439109899375, 0.4149124350099836, 0.4190615593600835, 0.4232521749536843, 0.4274846967032212, 0.4317595436702534, 0.4360771391069559, 0.44043791049802544, 0.44484228960300576, 0.44929071249903574, 0.4537836196240262, 0.45832145582026645, 0.4629046703784691, 0.4675337170822538, 0.47220905425307635, 0.47693114479560705, 0.48170045624356317, 0.4865174608059988, 0.49138263541405874, 0.4962964617681994, 0.5012594263858814, 0.5062720206497402, 0.5113347408562376, 0.5164480882647999, 0.5216125691474479, 0.5268286948389225, 0.5320969817873117, 0.5374179516051848, 0.5427921311212367, 0.5482200524324491, 0.5537022529567736, 0.5592392754863413, 0.5648316682412048, 0.5704799849236167, 0.576184784772853, 0.5819466326205814, 0.5877660989467873, 0.5936437599362552, 0.5995801975356178, 0.605575999510974, 0.6116317595060837, 0.6177480771011445, 0.623925557872156, 0.6301648134508775, 0.6364664615853863, 0.6428311262012402, 0.6492594374632525, 0.6557520318378851, 0.662309552156264, 0.6689326476778267, 0.6756219741546049, 0.682378193896151, 0.6892019758351124, 0.6960939955934635, 0.7030549355493982, 0.7100854849048922, 0.7171863397539412, 0.7243582031514806, 0.7316017851829955, 0.7389178030348253, 0.7463069810651737, 0.7537700508758254, 0.7613077513845836, 0.7689208288984295, 0.7766100371874137, 0.7843761375592879, 0.7922198989348808, 0.8001420979242296, 0.8081435189034718, 0.8162249540925066, 0.8243872036334317, 0.8326310756697661, 0.8409573864264637, 0.8493669602907282, 0.8578606298936355, 0.8664392361925719, 0.8751036285544977, 0.8838546648400426, 0.8926932114884432, 0.9016201436033277, 0.9106363450393609, 0.9197427084897545, 0.928940135574652, 0.9382295369303986, 0.9476118322997025, 0.9570879506226997, 0.9666588301289265, 0.9763254184302158, 0.986088672614518, 0.9959495593406631, 1.00590905493407, 1.0159681454834106, 1.0261278269382446, 1.036389105207627, 1.0467529962597035, 1.0572205262223004, 1.0677927314845235, 1.0784706587993687, 1.0892553653873625, 1.100147919041236, 1.1111493982316485, 1.122260892213965, 1.1334835011361046, 1.1448183361474655, 1.15626651950894, 1.1678291847040296, 1.17950747655107, 1.1913025513165807, 1.2032155768297466, 1.2152477325980442, 1.2274002099240244, 1.2396742120232647, 1.2520709541434973, 1.2645916636849324, 1.2772375803217817, 1.2900099561249996, 1.3029100556862496, 1.315939156243112, 1.3290985478055433, 1.3423895332835984, 1.3558134286164345, 1.369371562902599, 1.3830652785316249, 1.3968959313169413, 1.4108648906301107, 1.4249735395364118, 1.439223274931776, 1.4536155076810937, 1.4681516627579045, 1.4828331793854836, 1.4976615111793385, 1.512638126291132, 1.5277645075540434, 1.5430421526295837, 1.5584725741558796, 1.5740572998974383, 1.5897978728964128, 1.605695851625377, 1.6217528101416308, 1.637970338243047, 1.6543500416254773, 1.6708935420417323, 1.6876024774621496, 1.7044785022367712, 1.7215232872591386, 1.7387385201317302, 1.7561259053330476, 1.773687164386378, 1.791424036030242, 1.8093382763905443, 1.82743165915445, 1.8457059757459942, 1.864163035503454, 1.882804665858489, 1.9016327125170738, 1.9206490396422442, 1.9398555300386668, 1.9592540853390537, 1.9788466261924442, 1.9986350924543688, 2.0186214433789123, 2.0388076578127015, 2.0591957343908285, 2.0797876917347367, 2.1005855686520842, 2.121591424338605, 2.1428073385819912, 2.164235411967811, 2.185877766087489, 2.207736543748364, 2.229813909185848, 2.252112048277706, 2.2746331687604835, 2.297379500448088, 2.320353295452569, 2.343556828407095, 2.366992396691166, 2.3906623206580773, 2.4145689438646585, 2.438714633303305, 2.4631017796363377, 2.4877327974327015, 2.5126101254070283, 2.5377362266610985, 2.5631135889277097, 2.588744724816987, 2.6146321720651566, 2.6407784937858083, 2.6671862787236664, 2.693858141510903, 2.7207967229260124, 2.7480046901552724, 2.775484737056825, 2.803239584427393, 2.8312719802716675, 2.859584700074384, 2.888180547075128, 2.917062352545879, 2.9462329760713377, 2.975695305832051, 3.005452258890372, 3.0355067814792758, 3.0658618492940684, 3.096520467787009, 3.127485672464879, 3.158760529189528, 3.1903481344814235, 3.2222516158262375, 3.2544741319845, 3.287018873304345, 3.3198890620373884, 3.3530879526577624, 3.3866188321843396, 3.420485020506183, 3.4546898707112454, 3.489236769418358, 3.5241291371125416, 3.559370428483667, 3.594964132768504, 3.630913774096189, 3.6672229118371504, 3.703895140955522, 3.7409340923650776, 3.7783434332887285, 3.8161268676216156, 3.8542881362978316, 3.8928310176608103, 3.9317593278374185, 3.9710769211157926, 4.01078769032695, 4.05089556723022, 4.091404522902522, 4.132318568131548, 4.173641753812863, 4.2153781713509915, 4.257531953064501, 4.300107272595147, 4.343108345321098, 4.3865394287743085, 4.4304048230620525, 4.474708871292672, 4.5194559600056, 4.564650519605656, 4.610297024801713, 4.656399995049729, 4.702963995000227, 4.749993634950228, 4.797493571299731, 4.845468507012729, 4.893923192082856, 4.942862424003685, 4.992291048243722, 5.042213958726158, 5.09263609831342, 5.143562459296555, 5.19499808388952, 5.246948064728415, 5.2994175453757, 5.352411720829457, 5.405935838037752, 5.459995196418129, 5.51459514838231, 5.569741099866134, 5.625438510864795, 5.681692895973443, 5.738509824933177, 5.795894923182509, 5.853853872414334, 5.912392411138478, 5.971516335249863, 6.031231498602361, 6.091543813588385, 6.152459251724268, 6.213983844241511, 6.276123682683927, 6.3388849195107655, 6.402273768705874, 6.466296506392933, 6.530959471456862, 6.5962690661714305, 6.662231756833144, 6.728854074401477, 6.796142615145492, 6.8641040412969465, 6.932745081709915, 7.0020725325270154, 7.072093257852285, 7.1428141904308085, 7.2142423323351155, 7.286384755658467, 7.359248603215052, 7.432841089247202, 7.507169500139675, 7.582241195141072, 7.658063607092483, 7.734644243163408, 7.811990685595041, 7.890110592450992, 7.969011698375502, 8.048701815359257, 8.129188833512849, 8.210480721847977, 8.292585529066457, 8.375511384357123, 8.459266498200694, 8.5438591631827, 8.629297754814528, 8.715590732362674, 8.802746639686301, 8.890774106083162, 8.979681847143995, 9.069478665615435, 9.16017345227159, 9.251775186794305, 9.344292938662248, 9.437735868048872, 9.53211322672936, 9.627434358996654, 9.72370870258662, 9.820945789612487, 9.919155247508613]
#     salvatore_ps = [6.802397481356937e6, 6.7921283963557305e6, 6.781664601732715e6, 6.771002943862614e6, 6.760140088140339e6, 6.749072348357625e6, 6.7377961194495205e6, 6.726307188765598e6, 6.714602915752142e6, 6.7026793058285e6, 6.690532401310841e6, 6.678158220747213e6, 6.665552784995322e6, 6.652712305006973e6, 6.639633138962785e6, 6.626310898635703e6, 6.61274155227889e6, 6.5989206088469075e6, 6.584844089078367e6, 6.570507755950354e6, 6.5559068830958195e6, 6.541038300452057e6, 6.525896760758865e6, 6.510477690676816e6, 6.49477821295485e6, 6.478791490757329e6, 6.462513080146026e6, 6.44593945039416e6, 6.429064819813596e6, 6.411884770473204e6, 6.394395467559252e6, 6.3765905881783245e6, 6.358465884376215e6, 6.340016680076654e6, 6.321238502953459e6, 6.302125863213871e6, 6.282672461578719e6, 6.262874538133611e6, 6.242726080318568e6, 6.222222187876774e6, 6.20136019127877e6, 6.180132186668632e6, 6.158533499197399e6, 6.136557253202701e6, 6.114199079108923e6, 6.091454595087362e6, 6.068319283175108e6, 6.044784552036807e6, 6.020848067033229e6, 5.996501433897371e6, 5.971739535465663e6, 5.9465652440159675e6, 5.920965718576487e6, 5.894932999257226e6, 5.868465330226806e6, 5.841556632857103e6, 5.814201111936321e6, 5.786393810078347e6, 5.758130478961862e6, 5.729403297307149e6, 5.700207741005457e6, 5.670539837592137e6, 5.640393892354165e6, 5.609764039579734e6, 5.578645360940211e6, 5.547033528000118e6, 5.5149230553488685e6, 5.482308861880523e6, 5.449186782895127e6, 5.415550869481225e6, 5.381398097818179e6, 5.346723861819877e6, 5.311522665507113e6, 5.275790100714148e6, 5.239522023797548e6, 5.202715005129869e6, 5.165364869965057e6, 5.127467435744624e6, 5.089021748435666e6, 5.050020715131533e6, 5.010464175562771e6, 4.970347013308042e6, 4.929665784178453e6, 4.888421031695436e6, 4.846609475004734e6, 4.804229154104702e6, 4.761278561603646e6, 4.717754070402658e6, 4.6736572217334295e6, 4.628985465029589e6, 4.583740322056205e6, 4.53791922597988e6, 4.491523422605639e6, 4.444554124343317e6, 4.3970111235074e6, 4.348897770623493e6, 4.300213305864291e6, 4.250960690690203e6, 4.201142715227752e6, 4.1507628791324394e6, 4.099828552846453e6, 4.04833809401707e6, 3.996299335127924e6, 3.9437318577588983e6, 3.890603255878818e6, 3.8369359225998926e6, 3.782757561975261e6, 3.728064502119582e6, 3.67286232900588e6, 3.6171623168759076e6, 3.560968433280087e6, 3.5042827462929203e6, 3.4469764953886787e6, 3.388699757806399e6, 3.3315184952264586e6, 3.273093165825198e6, 3.2142315558821983e6, 3.1549716163536026e6, 3.095327395062157e6, 3.0353197473281957e6, 2.9749678272989527e6, 2.9142890974802556e6, 2.853306183598776e6, 2.792039095489962e6, 2.7305106283955406e6, 2.6687453123893063e6, 2.6067660433429168e6, 2.5445992536278577e6, 2.4822725954187117e6, 2.4198081441766787e6, 2.357243080219256e6, 2.2946063417249834e6, 2.231923721465087e6, 2.169232605451791e6, 2.1065648294131416e6, 2.0439538119398335e6, 1.9814382727188687e6, 1.9190542723130675e6, 1.8568400356317395e6, 1.7948355110597091e6, 1.7330824264675856e6, 1.6716202448553008e6, 1.6104949105293376e6, 1.5497503112418957e6, 1.4894345491104058e6, 1.4295920883205093e6, 1.3702706595644113e6, 1.3115124558406766e6, 1.2533790576416447e6, 1.1959133473951533e6, 1.139173266172594e6, 1.0832088951759965e6, 1.0280737883669959e6, 973825.474829104, 920511.8731407938, 868200.2985128748, 816939.546306567, 766787.6960822596, 717807.3210799238, 670055.7461912552, 623582.8350065027, 578462.7371434602, 534738.2516319966, 492476.1079328832, 451735.93945227924, 412577.15921634086, 375034.17484971, 339222.145257106, 305158.0054764837, 272890.0104085923, 242475.597937546, 213984.90088794893, 187461.29897369447, 162953.4728511162, 140516.09688469378, 120186.6646146673, 102014.0402939345, 86037.90278726592, 72309.48182755921, 60854.37830023244, 51714.41243871719, 44907.22967123648, 40468.0007747946, 38408.98050328151, 38751.67076012561, 41520.32386351205, 46717.61414035079, 54346.353841852884, 64412.41216400207, 76903.4171304131, 91822.52319989927, 109134.90130919014, 128823.15626631358, 150855.99614789858, 175199.97318450868, 201810.2235223725, 230621.2650111674, 261611.6873619648, 294697.8931832241, 329814.36269145156, 366873.5706671343, 405807.51456997433, 446512.11884756014, 488882.82233096956, 532830.7947723074, 578225.4473549079, 624921.8864396237, 672839.1061946531, 721792.3628650283, 771677.7495548619, 822315.1358006248, 873567.2417794873, 925268.8629041612, 977250.17604791, 1.0293209746303533e6, 1.0813125484012363e6, 1.1330441743226834e6, 1.1843306968337065e6, 1.2349762486740563e6, 1.2847907617545489e6, 1.333581452939105e6, 1.3811492263422594e6, 1.4272859999352018e6, 1.471837342678426e6, 1.5145847905485306e6, 1.5553413125540498e6, 1.5939167066585028e6, 1.6301310020297351e6, 1.6638400114472785e6, 1.6948294929501428e6, 1.7229535697294124e6, 1.748074515040892e6, 1.7700388826062884e6, 1.7887133234602737e6, 1.8039963931085544e6, 1.81582009848045e6, 1.823974260851672e6, 1.828489602808403e6, 1.8293002040395085e6, 1.8263358516987837e6, 1.8195906904969148e6, 1.8090677052019748e6, 1.7947688974949778e6, 1.7767826063344697e6, 1.7550392857320711e6, 1.7297068645909966e6, 1.7008460867366781e6, 1.6685831618584779e6, 1.6330591722054207e6, 1.59442140782174e6, 1.5528703811722153e6, 1.508560758471419e6, 1.4617145013374672e6, 1.412568380739899e6, 1.3613292014482399e6, 1.3082564564283926e6, 1.2536355001458563e6, 1.197765160935477e6, 1.140836564671022e6, 1.0832446092785192e6, 1.0251028598167604e6, 966826.7241594858, 908741.903692126, 850991.6959660762, 793976.145359053, 737918.3619685064, 683095.4510680152, 629726.0313789968, 578051.1516085721, 528218.4812644265, 480456.74540081347, 434922.26815864205, 391734.4417550022, 351051.8393045997, 312984.5541061011, 277520.3695722706, 244754.9115575513, 214717.00702673904, 187309.85656410502, 162562.83005484135, 140347.57363651542, 120649.08124300736, 103305.83391249599, 88267.00283405966, 75299.17690629617, 64307.67270836376, 55048.804365774915, 47325.143493335796, 41107.81175410393, 36162.66448119398, 32276.982658072862, 29279.695229671983, 26977.16480702952, 25248.78216472337, 24034.478181319046, 23016.12865809434, 22220.61836824321, 21544.735148700733, 20833.480738865463, 19789.30647216472, 19149.36053179779, 18013.704996714896, 16788.213798818724, 15654.411240005013, 14521.121082531561, 12954.776743007156, 11449.103496803036, 9512.815205041457, 7973.035671267051, 6811.068571088659, 5334.3969736237905, 4073.628041511155, 2785.7317677480078, 1951.7691113791695, 1248.8871875726315, 925.378066157922, 1010.9029322928576, 1262.9815320669784, 1305.433134183349, 1735.3863438359353, 2337.2930148136306, 2545.2942562585567, 3123.807649954432, 3742.155108523268, 4506.173619391037, 5066.224853791857, 5684.865061033538, 5883.328713975069, 6250.509056266497, 6185.531236975794, 6246.955902766929, 6297.692969668477, 6392.392071128872, 6248.190438662789, 6100.370895317388, 5510.087338107727, 5135.087963283341, 4515.228533772351, 4064.884376221803, 3546.847494098372, 3448.2167996722096, 3349.0126165203137, 3104.042740307925, 2842.8341422395, 2671.113541365098, 2512.7691126943505, 2678.041611213, 2891.7641185437565, 2245.9447881205547, 2348.02599854025, 1513.0860146728444, 1433.9621389836573, 1386.8666117859145, 586.6059118273678, 60.4168108648651, 629.1723821219374, 3645.1018029694155, 736.7503933703329, 907.345182104107, 1688.6607602946283, 56.61959430224069, 558.6334004664916, 725.1076534672079, 1322.570578634938, 84.23974724632377, 473.36999192094163, 0.001, 0.001, 732.5787159152643, 270.80660773505684, 91.22186257058979, 0.001, 714.1461713132155, 314.3128089556345, 757.4935734405417, 0.001, 225.75998348707054, 557.673817503685, 394.9252909324357, 316.2515898490973, 789.7757995181496, 578.6369705575005, 240.2245800950551, 0.001, 1931.047750149295, 731.0512471807441, 2553.681750423012, 2537.2953387626817, 1753.6261833719147, 0.001, 816.3674535012153, 533.8077921286205, 918.4425576118665, 468.81330047085567, 1855.9196918286207, 2213.7958158001425, 0.001, 0.001, 77.68556787103832, 279.12206897104704, 0.001, 0.001, 0.001, 0.001, 37.045060419228925, 0.001, 399.9085442034364, 35.47261680772306, 1108.0984416083406, 470.494130735389, 1170.908040535044, 421.57173821149723, 236.8517627509324, 523.0442020659342, 218.34804514920296, 0.001, 0.001, 826.5703775458823, 0.001, 0.001, 596.7820040277535, 1181.028752468016, 735.7610350205931, 2459.163251584256, 4060.1735495641806, 2604.836420327304, 2580.230765374659, 999.6715396726668, 1955.3173957638328, 0.001, 0.001, 583.4486208015221, 0.001, 0.001, 0.001, 0.001, 3222.4478254603378, 0.001, 0.001, 0.001, 1604.2824525712233, 265.17893977368783, 1440.7665934181468, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 137.4952081499342, 569.7855400369137, 0.001, 3410.3811777027763, 715.5783175613531, 0.001, 7.283774206187821, 2932.5012320924693, 324.5956021116277]
# end

begin
    figure = Figure()
    ax = Axis(figure[1, 1], xlabel=L"k[β]", ylabel=L"$\frac{1}{4πV}\int_{4π}|ψ_{PT}|^2 dn̂$",
              xscale=log10, yscale=log10,
              title="2 Bubble Volume-Volume, R=$R, d=$d")
    lines!(ax, ks, tp, label="Total")
    lines!(ax, ks, vp, linestyle=:dash, label="Volume-Volume")
    lines!(ax, ks, sp, linestyle=:dash, label="Surface-Surface")
    # lines!(ax, salvatore_ks, salvatore_ps, linestyle=:dash, label="Salvatore")
    # lines!(ax, ks, xsp, label="x̂")
    # lines!(ax, ks, ysp, linestyle=:dash, label="ŷ")
    # lines!(ax, ks, n̂sp, linestyle=:dash, color="red", label="μ=$μ, ϕ=$ϕ")
    # scatter!(ax, ks, n̂sp, color=(:blue, 0.1))
    axislegend(ax, position=:lb)
    save("/home/ben/Pictures/2_bubble_vv_ss_comparison.png", figure)
    figure
end

begin
    figure = Figure()
    ax = Axis(figure[1, 1], xlabel="k", ylabel="P(k)",
              xscale=log10, yscale=log10,
              title="2 Bubble Surface-Surface, R=$R, d=$d")
    lines!(ax, ks, sp)
    save("2_bubble_surface_surface.png", figure)
    figure
end

begin
    using CSV, DataFrames
    df = DataFrame(ks=ks, P=vp)
    # Save DataFrame to a CSV file
    CSV.write("./2_bubble_volume_volume_power_spectrum.csv", df)
end
